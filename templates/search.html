<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Tweet Search</title>
    <script src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tweet-container {
            min-height: 100px; /* Ensure space for embed loading */
            transition: all 0.3s ease;
        }
        .loading {
            opacity: 0.5;
        }
        /* Adjust column widths for three columns */
        .results-column {
            width: calc(33.333% - 1.333rem); /* (100% / 3) - (2/3 * gap) */
        }
        @media (max-width: 1024px) { /* Stack on medium screens and below */
            .results-container {
                flex-direction: column;
            }
            .results-column {
                width: 100%; /* Full width when stacked */
                margin-bottom: 2rem; /* Add space between stacked columns */
            }
        }
        .line-clamp-2 { /* Utility for description */
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        .line-clamp-3 { /* Utility for text */
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8">Semantic Tweet Search</h1>
        
        <!-- Search Form -->
        <div class="max-w-2xl mx-auto mb-8">
            <div class="flex gap-4">
                <input type="text" id="searchInput" 
                       class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Enter your search query...">
                <button onclick="performSearch(false)" 
                        class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Search
                </button>
            </div>
        </div>

        <!-- Mode Toggle -->
        <div class="max-w-2xl mx-auto mb-4 text-center">
            <label for="modeToggle" class="mr-2 text-gray-700">Search Mode:</label>
            <div class="inline-flex bg-gray-200 rounded-lg p-1">
                <button id="modeWeightedBtn" onclick="setSearchMode('weighted')" class="px-4 py-1 text-sm font-medium rounded-md text-white bg-blue-500 focus:outline-none">
                    Weighted (3 Lists)
                </button>
                <button id="modeTraditionalBtn" onclick="setSearchMode('traditional')" class="px-4 py-1 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-300 focus:outline-none">
                    Traditional (1 List)
                </button>
            </div>
            <input type="hidden" id="searchMode" value="weighted"> <!-- Hidden input to store current mode -->
        </div>

        <!-- Results Stats (Initially hidden, shown based on mode) -->
        <div id="resultsStats" class="max-w-4xl mx-auto mb-8 text-gray-600 hidden">
            <p>Found <span id="tweetCount">0</span> text tweets, <span id="mediaCombinedCount">0</span> text+media matches, and <span id="mediaImageOnlyCount">0</span> image-only matches.</p>
        </div>

        <!-- Results Container -->
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap lg:flex-nowrap gap-8 results-container">
                <!-- Text Tweets Column / Traditional Combined Column -->
                <div class="results-column" id="column-text">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold">Text Results</h2>
                        <button id="expandTweets" 
                                onclick="performSearch(true)" 
                                class="text-blue-500 hover:text-blue-700 hidden">
                            Show More →
                        </button>
                    </div>
                    <div id="tweetResults" class="space-y-4"></div>
                </div>
                
                <!-- Text + Media Tweets Column (Combined Score) -->
                <div class="results-column" id="column-combined">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold">Text + Media Results</h2>
                        <button id="expandMediaCombined" 
                                onclick="performSearch(true)" 
                                class="text-blue-500 hover:text-blue-700 hidden">
                            Show More →
                        </button>
                    </div>
                    <div id="mediaCombinedResults" class="space-y-4"></div>
                </div>

                <!-- Image-Only Media Tweets Column -->
                <div class="results-column" id="column-image">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-semibold">Image-Only Results</h2>
                        <button id="expandMediaImageOnly" 
                                onclick="performSearch(true)" 
                                class="text-blue-500 hover:text-blue-700 hidden">
                            Show More →
                        </button>
                    </div>
                    <div id="mediaImageOnlyResults" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lastQuery = '';
        let isExpanded = false;
        let currentSearchMode = 'weighted'; // Default mode

        function setSearchMode(mode) {
            currentSearchMode = mode;
            document.getElementById('searchMode').value = mode;
            // Update button styles
            const weightedBtn = document.getElementById('modeWeightedBtn');
            const traditionalBtn = document.getElementById('modeTraditionalBtn');
            if (mode === 'weighted') {
                weightedBtn.classList.add('bg-blue-500', 'text-white');
                weightedBtn.classList.remove('text-gray-600', 'hover:bg-gray-300');
                traditionalBtn.classList.remove('bg-blue-500', 'text-white');
                traditionalBtn.classList.add('text-gray-600', 'hover:bg-gray-300');
            } else {
                traditionalBtn.classList.add('bg-blue-500', 'text-white');
                traditionalBtn.classList.remove('text-gray-600', 'hover:bg-gray-300');
                weightedBtn.classList.remove('bg-blue-500', 'text-white');
                weightedBtn.classList.add('text-gray-600', 'hover:bg-gray-300');
            }
            // Re-run search if query exists when mode changes
            if (lastQuery) { 
                console.log(`Mode changed to ${mode}, re-running search for: ${lastQuery}`);
                performSearch(false); 
            }
        }

        async function performSearch(expandRequest = false) {
            const query = document.getElementById('searchInput').value;
            // If called by mode change, use lastQuery if current input is empty
            const effectiveQuery = query || lastQuery;
            if (!effectiveQuery) return;
            
            lastQuery = effectiveQuery; // Update last query
            // Ensure search input reflects current query if triggered by mode change
            if (!query && lastQuery) {
                document.getElementById('searchInput').value = lastQuery;
            }

            isExpanded = expandRequest;
            const mode = document.getElementById('searchMode').value;

            // Clear results for new search
            if (!isExpanded) {
                document.getElementById('tweetResults').innerHTML = '';
                document.getElementById('mediaCombinedResults').innerHTML = '';
                document.getElementById('mediaImageOnlyResults').innerHTML = '';
            }

            // Adjust layout based on mode *before* fetch
            const textCol = document.getElementById('column-text');
            const combinedCol = document.getElementById('column-combined');
            const imageCol = document.getElementById('column-image');
            const textColHeader = textCol.querySelector('h2');
            const statsContainer = document.getElementById('resultsStats');

            if (mode === 'traditional') {
                textCol.style.display = 'block';
                textCol.style.width = '100%';
                combinedCol.style.display = 'none';
                imageCol.style.display = 'none';
                textColHeader.textContent = "Traditional Combined Results";
                statsContainer.style.display = 'none'; // Hide stats in traditional mode
            } else { // Weighted mode
                textCol.style.display = 'block';
                combinedCol.style.display = 'block';
                imageCol.style.display = 'block';
                textCol.style.width = ''; // Reset width from potential traditional view
                textColHeader.textContent = "Text Results";
                statsContainer.style.display = 'block'; // Ensure stats are visible
            }

            document.body.style.cursor = 'wait';

            try {
                const response = await fetch(`/search?q=${encodeURIComponent(lastQuery)}&expanded=${isExpanded}&mode=${mode}`);
                const data = await response.json();

                if (mode === 'weighted') {
                    // --- Weighted Mode Display ---
                    statsContainer.classList.remove('hidden'); // Ensure stats div is not hidden
                    document.getElementById('tweetCount').textContent = data.tweets?.length ?? 0;
                    document.getElementById('mediaCombinedCount').textContent = data.media_combined?.length ?? 0;
                    document.getElementById('mediaImageOnlyCount').textContent = data.media_image_only?.length ?? 0;

                    displayResults(data.tweets, 'tweetResults', mode);
                    displayResults(data.media_combined, 'mediaCombinedResults', mode);
                    displayResults(data.media_image_only, 'mediaImageOnlyResults', mode);

                    document.getElementById('expandTweets').style.display = 
                        !isExpanded && data.has_more && data.tweets?.length > 0 ? 'block' : 'none';
                    document.getElementById('expandMediaCombined').style.display = 
                        !isExpanded && data.has_more && data.media_combined?.length > 0 ? 'block' : 'none';
                    document.getElementById('expandMediaImageOnly').style.display = 
                        !isExpanded && data.has_more && data.media_image_only?.length > 0 ? 'block' : 'none';
                    
                     // Trigger embed loading for all columns
                    setTimeout(() => {
                        if (window.twttr && window.twttr.widgets) {
                            window.twttr.widgets.load(document.getElementById('tweetResults'));
                            window.twttr.widgets.load(document.getElementById('mediaCombinedResults'));
                            window.twttr.widgets.load(document.getElementById('mediaImageOnlyResults'));
                        }
                    }, 100);

                } else if (mode === 'traditional') {
                     // --- Traditional Mode Display ---
                     displayResults(data.combined_results, 'tweetResults', mode); // Display in first column
                     // Hide expand buttons (or implement pagination for combined list)
                     document.getElementById('expandTweets').style.display = 'none'; 
                     document.getElementById('expandMediaCombined').style.display = 'none';
                     document.getElementById('expandMediaImageOnly').style.display = 'none';
                     
                     // Trigger embed loading for the first column
                     setTimeout(() => {
                        if (window.twttr && window.twttr.widgets) {
                            window.twttr.widgets.load(document.getElementById('tweetResults'));
                        }
                    }, 100);
                }

            } catch (error) {
                console.error('Error performing search:', error);
                 document.getElementById('tweetResults').innerHTML = '<p class="text-red-500">Error fetching results.</p>';
                 document.getElementById('mediaCombinedResults').innerHTML = ''; // Clear other columns on error
                 document.getElementById('mediaImageOnlyResults').innerHTML = '';
            } finally {
                 document.body.style.cursor = 'default';
            }
        }

        function displayResults(results, containerId, mode) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!results || results.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No results found.</p>';
                return;
            }
            appendResults(results, containerId, mode);
        }

        function appendResults(results, containerId, mode) {
            const container = document.getElementById(containerId);
            results.forEach(result => {
                 const resultDiv = document.createElement('div');
                 resultDiv.className = 'bg-white rounded-lg p-4 shadow tweet-container mb-4';

                 // --- Similarity Score --- 
                 const scoreDiv = document.createElement('div');
                 scoreDiv.className = 'text-sm text-gray-500 mb-2';
                 let scoreText = `Similarity: ${(result.similarity * 100).toFixed(1)}%`;
                 if (mode === 'traditional') {
                     // Add type info for traditional mode
                     scoreText += ` (Type: ${result.type?.replace('_', ' ') ?? 'N/A'})`;
                 } else if (containerId === 'mediaCombinedResults' && result.joint_similarity !== undefined && result.image_similarity !== undefined) {
                     // Add breakdown for weighted combined media results
                     scoreText += ` (Joint: ${(result.joint_similarity * 100).toFixed(0)}%, Image: ${(result.image_similarity * 100).toFixed(0)}%)`;
                 }
                 scoreDiv.textContent = scoreText;
                 resultDiv.appendChild(scoreDiv);

                // --- Tweet Text --- 
                const textDiv = document.createElement('div');
                textDiv.className = 'text-gray-700 mb-2 line-clamp-3';
                textDiv.textContent = result.text; // Assumes 'text' is available for all result types
                resultDiv.appendChild(textDiv);

                 // --- Image Description --- 
                 if (result.image_desc) {
                    const descDiv = document.createElement('div');
                    descDiv.className = 'text-sm text-gray-600 mt-2 italic line-clamp-2';
                    descDiv.textContent = `[AI Desc]: ${result.image_desc}`;
                    resultDiv.appendChild(descDiv);
                }

                 // --- Tweet Link --- 
                const linkDiv = document.createElement('div');
                linkDiv.className = 'text-sm text-blue-500 my-2';
                const statusId = result.id || result.tweet_id; // Handle both tweet and media results
                const tweetLink = statusId ? `https://twitter.com/x/status/${statusId}` : '#';
                linkDiv.innerHTML = `<a href="${tweetLink}" target="_blank" rel="noopener">View on Twitter →</a>`;
                resultDiv.appendChild(linkDiv);

                 // --- Tweet Embed --- 
                const tweetContainer = document.createElement('div');
                tweetContainer.className = 'tweet-embed border-t pt-2 mt-2';
                const embedHtml = statusId 
                    ? `<blockquote class="twitter-tweet" data-conversation="none" data-dnt="true"><p lang="en" dir="ltr">Loading tweet...</p>&mdash; User <a href="https://twitter.com/x/status/${statusId}">Date</a></blockquote>`
                    : '<p class="text-red-500">Embed requires tweet ID.</p>';
                tweetContainer.innerHTML = embedHtml;
                resultDiv.appendChild(tweetContainer);

                container.appendChild(resultDiv);
            });
        }

        // Handle enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch(false);
            }
        });

    </script>
</body>
</html> 